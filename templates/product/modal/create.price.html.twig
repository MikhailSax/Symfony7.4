<section>
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h3 mb-0 mt-3">Список цен продукта</h1>
            <div class="text-muted small">Управление ценами</div>
        </div>
        {% if errorMessage is defined %}
            <div class="alert alert-danger" role="alert">
                <div class="alert alert-danger" role="alert">
                    {{ errorMessage }}
                </div>
            </div>
        {% endif %}
        <div class="d-flex gap-2">
            <a href="{{ path('admin_properties_create') }}" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                <i class="bi bi-plus-lg me-1"></i>
                Добавить
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Название</th>
                        <th>Цена за шт.</th>
                        <th>Количество</th>
                        <th class="text-end" style="width: 120px;">Действия</th>
                    </tr>
                    </thead>

                    <tbody>
                    {% for price in prices %}
                        <tr>
                            <td class="text-muted">{{ price.id }}</td>

                            <td class="fw-semibold">
                                <a href="">{{ price.name }}</a>
                            </td>

                            <td>
                                <span>{{ price.price }} RUB</span>
                            </td>

                            <td>
                                {{ price.quantity }}
                            </td>
                            <td class="text-end">
                                <div class="btn-group" role="group" aria-label="Действия">
                                    <a href=""
                                       class="btn btn-sm btn-outline-primary"
                                       title="Редактировать"
                                       aria-label="Редактировать">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    <form method="post"
                                          action=""
                                          class="d-inline"
                                          data-controller="category"
                                          onsubmit="return confirm('Удалить категорию «{{ price.name }}»?');">
                                        <input type="hidden" name="_token"
                                               value="{{ csrf_token('delete' ~ price.id) }}">
                                        <button class="btn btn-sm btn-outline-danger"
                                                title="Удалить"
                                                aria-label="Удалить"
                                                data-action="click->category#greet"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                Характеристик пока нет
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Создание цены за тираж</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ path('product_price_new') }}" method="POST" class="form-create_price">
                    <div class="mb-3">
                        <label for="name" class="form-label">Название</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Количество</label>
                        <input type="number" class="form-control" id="quantity" name="quantity"required>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Цена за единицу</label>
                        <input type="text" id="price" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label for="product_id" class="form-label">ID товара</label>
                        <input class="form-control" type="number" id="product_id" name="product_id" value="{{ product.getId}}" readonly />
                    </div>
                    <button type="submit" class="btn btn-primary">Отправить</button>
                    <input type="hidden" id="csrf-token" value="{{ csrf_token('product_item') }}"/>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const priceForm = document.getElementById('price-form');

        if (priceForm) {
            priceForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // Останавливаем обычную перезагрузку страницы

                const form = e.target;

                // 1. Валидация на стороне браузера
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // 2. Сбор данных формы
                const formData = new FormData(form);

                // Преобразуем FormData в обычный объект
                // Если в вашем ProductPriceType есть getBlockPrefix() (обычно это имя сущности в нижнем регистре),
                // данные нужно вкладывать в ключ. Если вы сделали return ''; в getBlockPrefix, оставляйте так:
                const data = Object.fromEntries(formData.entries());

                try {
                    // 3. Отправка запроса
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Успех
                        alert('Цена успешно сохранена!');
                        location.reload(); // Перезагрузка для отображения данных
                    } else {
                        // Ошибка валидации Symfony или сервера
                        console.error('Validation errors:', result.errors);
                        alert('Ошибка при сохранении: ' + (result.errors || 'Проверьте введенные данные'));
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    alert('Произошла ошибка сети');
                }
            });
        }
    });
</script>
