{% extends 'admin.html.twig' %}
{% set route = app.request.attributes.get('_route') %}
{% block title %}{{ title }}{% endblock %}

{% block body %}
<!-- Заголовок страницы -->
<div class="admin-page-header">
    <div class="header-content">
        <h1>{{ title }}</h1>
        <p class="page-subtitle">Управление товарами каталога</p>
    </div>

    {% if errorMessage is defined %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ errorMessage }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <div class="header-actions d-flex align-items-center gap-3">
        <a href="{{ path('admin_product_create') }}" class="btn btn-primary btn-sm d-flex align-items-center gap-2">
            <i class="bi bi-plus-lg"></i>
            <span>Добавить товар</span>
        </a>
    </div>
</div>

<section class="admin-table-card promo-case mb-4" aria-label="Кейс полиграфической рекламной компании">
    <div class="card-body p-4">
        <div class="promo-case__head d-flex flex-wrap justify-content-between gap-3 mb-4">
            <div>
                <span class="promo-case__label">Кейс недели</span>
                <h2 class="promo-case__title mt-2 mb-2">«ПринтВектор» — наружная реклама и типография полного цикла</h2>
                <p class="promo-case__subtitle mb-0">
                    Производство баннеров, вывесок и рекламной полиграфии с доставкой и монтажом по городу за 48 часов.
                </p>
            </div>
            <div class="promo-case__badge align-self-start">
                <i class="bi bi-megaphone-fill"></i>
                B2B / B2C
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <article class="promo-case__metric h-100">
                    <p class="promo-case__metric-value">+37%</p>
                    <p class="promo-case__metric-title">Рост повторных заказов</p>
                    <p class="promo-case__metric-text">После внедрения пакетных предложений для магазинов и ТРЦ.</p>
                </article>
            </div>
            <div class="col-md-4">
                <article class="promo-case__metric h-100">
                    <p class="promo-case__metric-value">2 800 м²</p>
                    <p class="promo-case__metric-title">Баннерной печати в месяц</p>
                    <p class="promo-case__metric-text">Широкоформатная печать 1440 dpi для уличных кампаний.</p>
                </article>
            </div>
            <div class="col-md-4">
                <article class="promo-case__metric h-100">
                    <p class="promo-case__metric-value">24/7</p>
                    <p class="promo-case__metric-title">Онлайн-приём макетов</p>
                    <p class="promo-case__metric-text">Автопроверка файлов и запуск в печать без задержек менеджера.</p>
                </article>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-7">
                <div class="promo-case__panel h-100">
                    <h3>Что уже внедрено в кейсе</h3>
                    <ul class="promo-case__list mb-0">
                        <li><i class="bi bi-check2-circle"></i> Витрина услуг: баннеры, брендволлы, таблички, листовки, визитки.</li>
                        <li><i class="bi bi-check2-circle"></i> Прайс-пакеты «Старт», «Сезон», «Франшиза» для разных сегментов клиентов.</li>
                        <li><i class="bi bi-check2-circle"></i> Контроль производства: печать → постобработка → монтаж с чек-листом.</li>
                        <li><i class="bi bi-check2-circle"></i> Дашборд загрузки цеха и срочных заказов для менеджеров смены.</li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="promo-case__panel h-100 promo-case__panel--accent">
                    <h3>Приоритеты на этот месяц</h3>
                    <ul class="promo-case__checklist mb-0">
                        <li>Обновить сезонные макеты для outdoor-кампаний</li>
                        <li>Ускорить согласование цветопроб для крупных сетей</li>
                        <li>Подключить пакет «Монтаж под ключ» к онлайн-форме заказа</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="d-flex justify-content-end gap-3 mt-3 mb-3">
    <form action="{{ path('admin_product_index') }}" method="get" class="d-flex align-items-center gap-2">
        <div class="input-group mb-3" style="margin-right: 10px">
                <span class="input-group-text bg-white border-end-0" id="search-icon">
                        <i class="bi bi-search"></i>
                </span>
            <input type="search" name="search" id="search_products" placeholder="поиск"
                   class="form-control border-start-0">
        </div>
        <div class="input-group mb-3" style="width: 350px;">
            <select name="category" class="form-select form-select-sm border-start-0 ps-0 text-center">
                <option value="0">Все категории</option>
                {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.title }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center mb-3">Применить</button>
    </form>
</div>

<!-- Карточка с таблицей -->
<div class="admin-table-card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                <tr>
                    <th style="width: 80px;">ID</th>
                    <th>Название</th>
                    <th>URL</th>
                    <th>Описание</th>
                    <th>Категория</th>
                    <th class="text-end" style="width: 120px;">Действия</th>
                </tr>
                </thead>

                <tbody>
                {% for product in products %}
                    <tr data-id="{{ product.id }}">
                        <td class="entity-id" data-label="ID">#{{ product.id }}</td>

                        <td data-label="Название">
                            <div class="entity-title">
                                <a href="{{ path('admin_product_edit',{id: product.id }) }}">
                                    {{ product.title }}
                                </a>
                            </div>
                        </td>

                        <td data-label="URL">
                            <span class="badge entity-slug">{{ product.slug }}</span>
                        </td>

                        <td class="entity-description" data-label="Описание">
                            {% if product.shortDescription %}
                                <span class="text-truncate-2">{{ product.shortDescription }}</span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <td data-label="Категория">
                            {% if product.category %}
                                <span class="badge bg-light">
                                        {{ product.category.title }}
                                    </span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <td class="entity-actions text-end" data-label="Действия">
                            <div class="btn-group" role="group">
                                <a href="{{ path('admin_product_edit', {id: product.id}) }}"
                                   class="btn btn-outline-primary"
                                   title="Редактировать">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form method="post"
                                      action="{{ path('admin_product_delete', {id: product.id}) }}"
                                      class="d-inline"
                                      onsubmit="return confirm('Удалить товар «{{ product.title }}»?');">
                                    <input type="hidden" name="_token"
                                           value="{{ csrf_token('delete' ~ product.id) }}">
                                    <button type="submit"
                                            class="btn btn-outline-danger"
                                            title="Удалить">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr class="empty-row">
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="bi bi-inbox"></i>
                                </div>
                                <p class="empty-text">Товаров пока нет</p>
                                <div class="empty-action">
                                    <a href="{{ path('admin_product_create') }}" class="btn btn-link">
                                        Добавить первый товар
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {#        <!-- Пагинация (если нужно) --> #}
    {#        {% if products|length > 10 %} #}
    {#            <div class="pagination-container d-flex justify-content-between align-items-center"> #}
    {#                <div class="pagination-info"> #}
    {#                    Показано {{ products|length }} из {{ totalCount ?? products|length }} товаров #}
    {#                </div> #}
    {#                <nav aria-label="Навигация по страницам"> #}
    {#                    <ul class="pagination pagination-sm mb-0"> #}
    {#                        <li class="page-item {% if currentPage <= 1 %}disabled{% endif %}"> #}
    {#                            <a class="page-link" #}
    {#                               href="{{ path(route, {page: currentPage - 1}) }}" #}
    {#                               tabindex="-1"> #}
    {#                                Назад #}
    {#                            </a> #}
    {#                        </li> #}
    {#                        {% for page in 1..totalPages %} #}
    {#                            <li class="page-item {% if page == currentPage %}active{% endif %}"> #}
    {#                                <a class="page-link" href="{{ path(route, {page: page}) }}"> #}
    {#                                    {{ page }} #}
    {#                                </a> #}
    {#                            </li> #}
    {#                        {% endfor %} #}
    {#                        <li class="page-item {% if currentPage >= totalPages %}disabled{% endif %}"> #}
    {#                            <a class="page-link" #}
    {#                               href="{{ path(route, {page: currentPage + 1}) }}"> #}
    {#                                Вперед #}
    {#                            </a> #}
    {#                        </li> #}
    {#                    </ul> #}
    {#                </nav> #}
    {#            </div> #}
    {#        {% endif %} #}
    {#    </div> #}

    <!-- JavaScript для tooltips -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Инициализация tooltips Bootstrap 5
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Подтверждение удаления с улучшенным UX
            document.querySelectorAll('form').forEach(form => {
                if (form.action.includes('delete')) {
                    const button = form.querySelector('button[type="submit"]');
                    if (button) {
                        button.addEventListener('click', function (e) {
                            const row = this.closest('tr');
                            const entityName = row.querySelector('.entity-title a').textContent.trim();
                            if (!confirm(`Вы уверены, что хотите удалить «${entityName}»?\nЭто действие нельзя отменить.`)) {
                                e.preventDefault();
                            }
                        });
                    }
                }
            });

            // Подсветка строк при наведении
            const rows = document.querySelectorAll('.admin-table tbody tr:not(.empty-row)');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
                });

                row.addEventListener('mouseleave', function () {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });
            });
        });
    </script>

    {% endblock %}
