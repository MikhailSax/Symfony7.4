{% extends 'admin.html.twig' %}
{% set route = app.request.attributes.get('_route') %}
{% block title %}{{ title }}{% endblock %}

{% block body %}
    <!-- Заголовок страницы -->
    <div class="admin-page-header">
        <div class="header-content">
            <h1>{{ title }}</h1>
            <p class="page-subtitle">Управление категориями каталога</p>
        </div>

        {% if errorMessage is defined %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ errorMessage }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <div class="header-actions">
            <a href="{{ path('admin_category_create') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>
                Добавить категорию
            </a>
        </div>
    </div>

    <!-- Карточка с таблицей -->
    <div class="admin-table-card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Название</th>
                        <th>URL</th>
                        <th>Короткое описание</th>
                        <th>Родитель</th>
                        <th class="text-end" style="width: 120px;">Действия</th>
                    </tr>
                    </thead>

                    <tbody class="mt-3">
                    {% for category in categories %}
                        <tr>
                            <td class="entity-id" data-label="ID">{{ category.id }}</td>

                            <td data-label="Название">
                                <div class="entity-title">
                                    <a href="{{ path('admin_category_edit',{slug: category.slug }) }}">
                                        {{ category.title }}
                                    </a>
                                </div>
                            </td>

                            <td>
                                <span>{{ category.slug }}</span>
                            </td>

                            <td class="entity-description" data-label="Короткое описание">
                                {% if category.shortDesc %}
                                    <span class="text-truncate-1">{{ category.shortDesc }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>

                            <td data-label="Родитель">
                                {% if category.parent %}
                                    <span class="entity-relation">{{ category.parent.title }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>

                            <td class="entity-actions text-end" data-label="Действия">
                                <div class="btn-group" role="group">
                                    <a href="{{ path('admin_category_edit', {slug: category.slug}) }}"
                                       class="btn btn-outline-primary"
                                       title="Редактировать">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    <form method="post"
                                          action="{{ path('admin_category_delete', {slug: category.slug}) }}"
                                          class="d-inline"
                                          onsubmit="return confirm('Удалить категорию «{{ category.title }}»?');">
                                        <input type="hidden" name="_token"
                                               value="{{ csrf_token('delete' ~ category.slug) }}">
                                        <button class="btn btn-outline-danger"
                                                title="Удалить"
                                                type="submit">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr class="empty-row">
                            <td colspan="6">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-folder"></i>
                                    </div>
                                    <p class="empty-text">Категорий пока нет</p>
                                    <div class="empty-action">
                                        <a href="{{ path('admin_category_create') }}" class="btn btn-link">
                                            Создать первую категорию
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Пагинация (если нужно) -->
        {% if categories|length > 10 %}
            <div class="pagination-container d-flex justify-content-between align-items-center">
                <div class="pagination-info">
                    Показано {{ categories|length }} из {{ totalCount ?? categories|length }} категорий
                </div>
                <nav aria-label="Навигация по страницам">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item {% if currentPage <= 1 %}disabled{% endif %}">
                            <a class="page-link"
                               href="{{ path(route, {page: currentPage - 1}) }}"
                               tabindex="-1">
                                Назад
                            </a>
                        </li>
                        {% for page in 1..totalPages %}
                            <li class="page-item {% if page == currentPage %}active{% endif %}">
                                <a class="page-link" href="{{ path(route, {page: page}) }}">
                                    {{ page }}
                                </a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if currentPage >= totalPages %}disabled{% endif %}">
                            <a class="page-link"
                               href="{{ path(route, {page: currentPage + 1}) }}">
                                Вперед
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        {% endif %}
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация tooltips Bootstrap 5
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Подтверждение удаления
            document.querySelectorAll('form').forEach(form => {
                if (form.action.includes('delete')) {
                    const button = form.querySelector('button[type="submit"]');
                    if (button) {
                        button.addEventListener('click', function(e) {
                            const row = this.closest('tr');
                            const entityName = row.querySelector('.entity-title a').textContent.trim();
                            if (!confirm(`Вы уверены, что хотите удалить «${entityName}»?\nЭто действие нельзя отменить.`)) {
                                e.preventDefault();
                            }
                        });
                    }
                }
            });

            // Подсветка строк при наведении
            const rows = document.querySelectorAll('.admin-table tbody tr:not(.empty-row)');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
                });

                row.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });
            });
        });
    </script>

{% endblock %}
