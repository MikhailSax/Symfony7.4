# Техническая спецификация: Web-to-Print платформа на Symfony 7.4

## 1. Цель проекта

Создать корпоративный сайт с личным кабинетом клиента и административной панелью (ERP/CRM ядро) для автоматизации:

- приема заказов на полиграфию и наружную рекламу;
- расчета стоимости в реальном времени;
- управления производственным циклом (от макета до отгрузки);
- контроля финансов, отчетности и клиентской базы.

## 2. Технологический стек

- **Backend:** PHP 8.1+ / Symfony 7.4
- **ORM:** Doctrine ORM
- **БД:** MySQL или PostgreSQL
- **Admin UI:** EasyAdmin 4.x (рекомендуется) или SonataAdminBundle
- **Frontend:** Twig + JavaScript (опционально Vue.js для калькуляторов)
- **Файлы:** VichUploaderBundle/Flysystem, обработка превью через Imagick/Ghostscript
- **API (опционально):** API Platform

## 3. Функциональные модули

### 3.1. Управление заказами (CRM-ядро)

1. **Лента заказов (Dashboard)**
   - фильтрация по статусам: `Новый`, `Расчет`, `Макетирование`, `В печати`, `Готов к выдаче`, `Доставка`, `Архив`;
   - быстрый поиск по номеру, клиенту, дате, менеджеру.

2. **Карточка заказа**
   - состав заказа (тираж, размер, материал, постпечатка);
   - прикрепленные файлы макетов с превью;
   - технические предупреждения по макету (preflight);
   - таймлайн статусов и история коммуникации.

3. **Производственная очередь**
   - Kanban-представление этапов;
   - назначение оборудования и оператора;
   - контроль загрузки по временным слотам.

### 3.2. Прайсы и Web-to-Print калькуляторы

1. **Редактор продуктов**
   - создание продуктовых карточек: визитки, баннеры, листовки, холсты, фотокниги;
   - конфигурируемые атрибуты (тираж, материал, формат, постпечатка).

2. **Формульный движок ценообразования**
   - хранение формул в БД;
   - вычисление по переменным (ширина, высота, плотность, коэффициенты);
   - поддержка пользовательских коэффициентов (скидка клиента, срочность).

3. **Импорт/экспорт прайсов**
   - CSV/XLSX-процессы обновления цен;
   - dry-run режим валидации до применения;
   - журнал изменений цен.

4. **Интеграция с 1С (этап 2+)**
   - обмен прайсами и заказами через XML/Excel;
   - лог ошибок синхронизации и механизм повторной отправки.

### 3.3. Управление макетами (DAM)

- централизованная библиотека файлов;
- структура хранения `Клиент/Год/НомерЗаказа`;
- preflight-проверки: DPI, шрифты, цветовая модель, bleed;
- хранение технического отчета по каждому файлу.

### 3.4. Финансы и отчеты

- статусы оплат (нал/безнал/эквайринг);
- расчет валовой маржи (себестоимость материалов + трудозатраты);
- дашборды по выручке, популярным услугам, загруженности оборудования.

### 3.5. Управление клиентами (CRM)

- сегментация B2B/B2C;
- карточка клиента с историей заказов;
- персональные скидки и договорные условия;
- экспорт клиентской базы для менеджеров.

## 4. Модель данных (Domain entities)

Минимальный набор сущностей для реализации:

- `User` — роли: `ROLE_ADMIN`, `ROLE_MANAGER`, `ROLE_CLIENT`.
- `Category` — классификация продуктов.
- `Product` — типографский продукт.
- `ProductAttribute` — параметр продукта (материал, формат, тираж и т.д.).
- `ProductAttributeValue` — допустимые значения параметра.
- `PricingRule` — формула расчета цены + условия применения.
- `Order` — заказ клиента (статус, суммы, сроки, клиент).
- `OrderItem` — слепок выбранной конфигурации и цены на момент заказа.
- `FileAsset` — загруженные макеты/файлы с результатами preflight.
- `Payment` — транзакции и статусы оплаты.
- `CostItem` — данные по себестоимости материалов/работ.
- `OrderStatusHistory` — аудит изменения статусов.

## 5. Архитектурные принципы

1. **Service Layer**
   - `PriceCalculationService` — расчет итоговой стоимости;
   - `FormulaEvaluationService` — безопасный расчет формул;
   - `OrderWorkflowService` — смена статусов и бизнес-ограничения;
   - `PreflightService` — анализ файлов макетов;
   - `StoragePathResolver` — генерация умных папок.

2. **DDD-lite подход**
   - бизнес-логика в сервисах/доменных объектах;
   - контроллеры только оркестрируют запрос/ответ;
   - валидация через Symfony Validator и value objects.

3. **Событийная модель**
   - Symfony EventDispatcher/Messenger для фоновых задач:
     - генерация превью;
     - preflight-анализ;
     - обмен с 1С;
     - уведомления клиенту.

## 6. Безопасность и соответствие требованиям

- CSRF, XSS и серверная валидация входных данных;
- разграничение прав по ролям и ACL к заказам/файлам;
- аудит действий администраторов;
- подготовка процессов к требованиям 152-ФЗ (персональные данные, сроки хранения, доступ).

## 7. Клиентская часть

- динамический калькулятор стоимости без перезагрузки (AJAX/Vue);
- личный кабинет: история заказов, повтор заказа, статусы;
- drag-and-drop загрузка файлов;
- опциональный онлайн-редактор макетов (MVP+).

## 8. Roadmap реализации

1. **Этап 1 — Foundation**
   - финализация схемы БД и ролей;
   - базовые CRUD в админке;
   - первичный workflow заказа.

2. **Этап 2 — Pricing Engine**
   - формульный движок;
   - редактор атрибутов и правил цены;
   - импорт/экспорт прайсов.

3. **Этап 3 — Production + DAM**
   - очередь производства (Kanban);
   - библиотека макетов и preflight;
   - асинхронные задачи обработки файлов.

4. **Этап 4 — Finance + CRM**
   - оплаты, себестоимость, прибыль;
   - отчеты и дашборды;
   - персональные скидки.

5. **Этап 5 — Integrations**
   - 1С модуль обмена;
   - расширенные API для внешних клиентов/SPA.

## 9. Критерии готовности MVP

MVP считается готовым при наличии:

- рабочего цикла заказа от создания до завершения;
- динамического расчета цены минимум для 2 типов продуктов;
- личного кабинета клиента;
- базовой админ-панели для менеджера;
- загрузки и хранения файлов макетов;
- базовой отчетности по заказам и выручке.
